default_platform(:ios)

platform :ios do

  ############################################################
  # Lane: beta
  # Purpose: Build the app, bump build number, upload to TestFlight
  ############################################################
  lane :beta do
    # Sync build number with CI or increment locally
    increment_build_number(
      xcodeproj: "BudgetTrackerApp2.xcodeproj"
    )

    # Build the app for release
    build_app(
      scheme: "BudgetTrackerApp2",
      export_method: "app-store",
      allowProvisioningUpdates: true
    )

    # Upload to TestFlight
    upload_to_testflight(
      skip_waiting_for_build_processing: true
    )

    # Tag the build in Git
    add_git_tag(
      tag: "build-#{lane_context[SharedValues::BUILD_NUMBER]}"
    )
    push_to_git_remote
  end



  ############################################################
  # Lane: release
  # Purpose: Full App Store release workflow
  # - bump version
  # - bump build number
  # - build
  # - upload to App Store
  # - tag version
  ############################################################
  lane :release do |options|

    # Optional: bump version number (major/minor/patch)
    bump_type = options[:bump] || "patch"

    increment_build_number(
      xcodeproj: "BudgetTrackerApp2.xcodeproj"
    )

    # Build for App Store
    build_app(
      scheme: "BudgetTrackerApp2",
      export_method: "app-store",
      allowProvisioningUpdates: true
    )

    # Upload to App Store Connect (not TestFlight)
    upload_to_app_store(
      submit_for_review: false,
      automatic_release: false
    )

    # Tag the release
    version = get_version_number(
      xcodeproj: "BudgetTrackerApp2.xcodeproj"
    )

    add_git_tag(tag: "v#{version}")
    push_to_git_remote
  end

end

