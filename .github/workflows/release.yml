name: iOS Release Pipeline (Fastlane)

on:
  workflow_dispatch:
  push:
    tags:
      - 'v*'

jobs:
  ios-ci:
    runs-on: macos-latest

    steps:
    - name: Checkout source
      uses: actions/checkout@v4

    - name: Select Xcode 26.2
      run: sudo xcode-select -s /Applications/Xcode_26.2.app

    - name: Install Ruby dependencies
      run: |
        gem install bundler
        bundle install || true

    - name: Install Fastlane
      run: sudo gem install fastlane

    - name: Install signing certificate
      run: |
        echo "$IOS_CERTIFICATE_BASE64" | base64 --decode > certificate.p12
        security create-keychain -p "" build.keychain
        security import certificate.p12 -k build.keychain -P "$IOS_CERTIFICATE_PASSWORD" -A
        security list-keychains -s build.keychain
        security default-keychain -s build.keychain
        security unlock-keychain -p "" build.keychain
        security set-keychain-settings build.keychain
      env:
        IOS_CERTIFICATE_BASE64: ${{ secrets.IOS_CERTIFICATE_BASE64 }}
        IOS_CERTIFICATE_PASSWORD: ${{ secrets.IOS_CERTIFICATE_PASSWORD }}

    - name: Install provisioning profile
      run: |
        mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
        echo "$IOS_PROVISIONING_PROFILE_BASE64" | base64 --decode > ~/Library/MobileDevice/Provisioning\ Profiles/iBudgetBuddy.mobileprovision
      env:
        IOS_PROVISIONING_PROFILE_BASE64: ${{ secrets.IOS_PROVISIONING_PROFILE_BASE64 }}

    - name: Run Fastlane lane
      env:
        APP_STORE_CONNECT_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
        APP_STORE_CONNECT_KEY_ID: ${{ secrets.APP_STORE_CONNECT_KEY_ID }}
        APP_STORE_CONNECT_PRIVATE_KEY: ${{ secrets.APP_STORE_CONNECT_PRIVATE_KEY }}
        APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
      run: |
        if [[ "${GITHUB_REF}" == refs/tags/v* ]]; then
          echo "Running release lane"
          fastlane release
        else
          echo "Running beta lane"
          fastlane beta
        fi

