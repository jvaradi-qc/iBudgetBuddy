name: iOS Release Pipeline (Fastlane)

on:
  workflow_dispatch:
  push:
    tags:
      - 'v*'

jobs:
  ios-ci:
    runs-on: macos-latest

    steps:
    - name: Checkout source
      uses: actions/checkout@v4

    - name: Select Xcode 26.2
      run: sudo xcode-select -s /Applications/Xcode_26.2.app

    - name: Install Ruby dependencies
      run: |
        gem install bundler
        bundle install || true

    - name: Install Fastlane
      run: sudo gem install fastlane

    - name: Install signing certificate (login keychain only)
      env:
        IOS_CERTIFICATE_BASE64: ${{ secrets.IOS_CERTIFICATE_BASE64 }}
        IOS_CERTIFICATE_PASSWORD: ${{ secrets.IOS_CERTIFICATE_PASSWORD }}
      run: |
        echo "$IOS_CERTIFICATE_BASE64" | base64 --decode > certificate.p12

        # Unlock login keychain
        security unlock-keychain -p "" ~/Library/Keychains/login.keychain-db

        # Import certificate into login keychain
        security import certificate.p12 \
          -k ~/Library/Keychains/login.keychain-db \
          -P "$IOS_CERTIFICATE_PASSWORD" \
          -A

        # Ensure login keychain is used
        security list-keychains -s ~/Library/Keychains/login.keychain-db
        security default-keychain -s ~/Library/Keychains/login.keychain-db
        security set-keychain-settings ~/Library/Keychains/login.keychain-db

        # Verify identity is available
        security find-identity -v ~/Library/Keychains/login.keychain-db

    - name: Install provisioning profile
      env:
        IOS_PROVISIONING_PROFILE_BASE64: ${{ secrets.IOS_PROVISIONING_PROFILE_BASE64 }}
      run: |
        mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
        echo "$IOS_PROVISIONING_PROFILE_BASE64" | base64 --decode > \
          ~/Library/MobileDevice/Provisioning\ Profiles/iBudgetBuddy.mobileprovision

    - name: Run Fastlane lane
      env:
        APP_STORE_CONNECT_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
        APP_STORE_CONNECT_KEY_ID: ${{ secrets.APP_STORE_CONNECT_KEY_ID }}
        APP_STORE_CONNECT_PRIVATE_KEY: ${{ secrets.APP_STORE_CONNECT_PRIVATE_KEY }}
        APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
      run: |
        if [[ "${GITHUB_REF}" == refs/tags/v* ]]; then
          echo "Running release lane"
          fastlane release
        else
          echo "Running beta lane"
          fastlane beta
        fi

    # ðŸ”¥ NEW: Upload gym logs when Fastlane fails
    - name: Upload gym log
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: gym-log
        path: ~/Library/Logs/gym
